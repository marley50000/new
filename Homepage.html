<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Spark Ghana</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { opacity: 0; transform: translateY(20px); animation: fadeInUp 1s ease-out forwards; }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-[#ffff] min-h-screen p-4">
  <main class="max-w-7xl mx-auto fade-in">
    <h1 class="text-3xl font-bold text-center mb-6">Find verified agents in Ghana</h1>

    <!-- Button to Register as Agent -->
    <div class="text-center mb-8">
      <a href="Registration As Agent.html" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        <svg class="-ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" />
        </svg>
        Become an Agent
      </a>
    </div>

    <!-- Search Bar -->
    <form class="max-w-md mx-auto relative mb-10">
      <input id="searchInput" type="text" placeholder="Find agents near you..." class="w-full rounded-lg py-3 px-4 pr-12 text-gray-700 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 shadow-sm" />
      <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-600 hover:text-gray-900"><i class="fas fa-search"></i></button>
    </form>

    <!-- Categories -->
    <div class="flex flex-wrap justify-center gap-4 mb-8">
      <button class="category-btn"><i class="fas fa-home text-blue-600 text-2xl"></i><br>Rentals</button>
      <button class="category-btn"><i class="fas fa-shield-alt text-blue-600 text-2xl"></i><br>Insurance</button>
      <button class="category-btn"><i class="fas fa-gavel text-blue-600 text-2xl"></i><br>Legal Help</button>
      <button class="category-btn"><i class="fas fa-passport text-blue-600 text-2xl"></i><br>Visa</button>
      <button class="category-btn"><span class="text-2xl font-bold">...</span><br>Others</button>
    </div>

    <!-- Featured Agents -->
    <section class="bg-white rounded-3xl p-6 mb-10 shadow-md">
      <h2 class="text-xl font-semibold mb-6 flex items-center">
        Verified Agents
        <span class="ml-2 inline-flex items-center justify-center w-5 h-5 bg-green-500 text-white rounded-full">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
        </span>
      </h2>
      
      <div id="featured-agents-container" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-6"></div>
      <p id="featured-loading" class="text-center text-gray-500 mt-4">Loading featured agents...</p>
    </section>

    <!-- New Section for Random Agents -->
    <section class="bg-white rounded-3xl p-6 mb-10 shadow-md">
      <h2 class="text-xl font-semibold mb-6">Other Agents You Might Like</h2>
      <div id="random-agents-container" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-6"></div>
      <p id="random-loading" class="text-center text-gray-500 mt-4">Loading other agents...</p>
    </section>

    <!-- Why Choose Section -->
    <section class="flex flex-wrap justify-around items-center bg-white p-6 rounded-3xl shadow-md">
      <h3 class="text-xl font-semibold w-full text-center mb-4">Why Choose Verified Agents?</h3>
      <div class="flex flex-wrap justify-center gap-6 w-full">
        <div class="flex items-center gap-2 text-sm font-medium text-gray-700">
          <i class="fas fa-user-check text-blue-600"></i> Verified Professionals
        </div>
        <div class="flex items-center gap-2 text-sm font-medium text-gray-700">
          <i class="fas fa-thumbs-up text-blue-600"></i> Trusted by Users
        </div>
        <div class="flex items-center gap-2 text-sm font-medium text-gray-700">
          <i class="fas fa-shield-alt text-blue-600"></i> Peace of Mind
        </div>
      </div>
    </section>
  </main>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const supabaseUrl = 'https://qzddjvloicjwshggzctt.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZGRqdmxvaWNqd3NoZ2d6Y3R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MDk5MzMsImV4cCI6MjA2NDk4NTkzM30.mkrERrCanIkNnIlch5UJ-OOJ9az7oXs1EFZijkf7y7o'; // Add your real key here
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
      const storageBaseUrl = `${supabaseUrl}/storage/v1/object/public/agent-images/`;
      const userAuthSection = document.getElementById('user-auth-section');
    
      async function checkUserAndDisplayAuth() {
        const { data: { user }, error } = await supabase.auth.getUser();
    
        if (error) {
          console.error("Error getting user:", error.message);
          // Optionally display a login/signup link if there's an error or no user
          userAuthSection.innerHTML = `<a href="#" class="text-blue-600 hover:underline text-sm">Login / Sign Up</a>`;
          return;
        }
    
        if (user) {
          const userName = user.user_metadata?.full_name || user.email;
          userAuthSection.innerHTML = `
            <span class="text-gray-700 text-sm mr-2">Welcome, ${userName}!</span>
            <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-3 rounded-md">Logout</button>
          `;
          document.getElementById('logoutButton').addEventListener('click', async () => {
            const { error: signOutError } = await supabase.auth.signOut();
            if (signOutError) {
              console.error("Error signing out:", signOutError.message);
            } else {
              window.location.reload(); // Reload page to reflect logged out state
            }
          });
        } else {
          // If no user is logged in, display a login/signup link
          userAuthSection.innerHTML = `<a href="#" class="text-blue-600 hover:underline text-sm">Login / Sign Up</a>`;
        }
      }
    
      // Call this function when the page loads to check user status
      checkUserAndDisplayAuth();

      // Utility function to shuffle an array (Fisher-Yates algorithm)
      function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]]; // Swap elements
          }
          return array;
      }
    
      async function loadFeaturedAgents() { // Renamed from loadAgents
        const { data, error } = await supabase
            .from('agents')
            .select('*')
            .order('is_featured', { ascending: false })  // show featured first
            .order('created_at', { ascending: false });   // then newest first

        const container = document.getElementById('featured-agents-container'); // Updated ID
        const loading = document.getElementById('featured-loading'); // Updated ID
    
        if (error || !data) {
            loading.textContent = "Failed to load featured agents.";
            return;
        }
    
        container.innerHTML = '';
        loading.style.display = 'none';

        // Filter to only display agents explicitly marked as featured
        const featuredAgents = data.filter(agent => agent.is_featured);

        if (featuredAgents.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 col-span-full">No featured agents available at the moment.</p>';
            return;
        }
    
        for (const agent of featuredAgents) { // Iterate over filtered featuredAgents
          let photoUrl = 'https://via.placeholder.com/300';
          if (agent.photo_path) {
            // Ensure photo_path doesn't duplicate the bucket name already in storageBaseUrl
            const cleanedPath = agent.photo_path.startsWith('agent-images/')
                ? agent.photo_path.replace('agent-images/', '')
                : agent.photo_path;
            photoUrl = `${storageBaseUrl}${cleanedPath}`;
          }
    
          container.innerHTML += `
            <article class="bg-[#f7f9fc] rounded-xl overflow-hidden shadow-sm flex flex-col">
              <img src="${photoUrl}" class="w-full object-cover object-top aspect-square" alt="${agent.full_name}" />
              <div class="p-3">
                <h3 class="font-semibold text-base">${agent.full_name}</h3>
               <p class="text-sm text-green-500 flex items-center">
  <span class="inline-flex items-center justify-center w-5 h-5 bg-green-500 text-white rounded-full mr-1">
    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.09 3.36h3.53c.969 0 1.371 1.24.588 1.81l-2.857 2.073 1.09 3.36c.3.922-.755 1.688-1.54 1.118L10 12.347l-2.857 2.073c-.784.57-1.838-.196-1.539-1.118l1.09-3.36-2.857-2.073c-.784-.57-.38-1.81.588-1.81h3.53l1.09-3.36z"/>
    </svg>
  </span>
  ${agent.rating || '4.5'}
</p>

                <p class="text-xs text-gray-800">${agent.category || 'Agent'}</p>
                <button class="mt-2 bg-blue-900 hover:bg-green-600 text-white rounded-md py-1 px-4 text-sm w-full">
  View Profile
</button>

              </div>
            </article>`;
        }
      }

      async function loadRandomAgents() {
        const { data, error } = await supabase
            .from('agents')
            .select('*')
            .eq('is_featured', false) // Only get non-featured agents
            .limit(20); // Fetch a reasonable number to shuffle from

        const container = document.getElementById('random-agents-container');
        const loading = document.getElementById('random-loading');

        if (error || !data) {
            loading.textContent = "Failed to load other agents.";
            return;
        }

        container.innerHTML = '';
        loading.style.display = 'none';

        if (data.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 col-span-full">No other agents available at the moment.</p>';
            return;
        }

        const shuffledAgents = shuffleArray(data).slice(0, 8); // Shuffle and take up to 8 random agents

        for (const agent of shuffledAgents) {
            let photoUrl = 'https://via.placeholder.com/300';
            if (agent.photo_path) {
                // Ensure photo_path doesn't duplicate the bucket name already in storageBaseUrl
                const cleanedPath = agent.photo_path.startsWith('agent-images/')
                    ? agent.photo_path.replace('agent-images/', '')
                    : agent.photo_path;
                photoUrl = `${storageBaseUrl}${cleanedPath}`;
            }

            container.innerHTML += `
                <article class="bg-[#f7f9fc] rounded-xl overflow-hidden shadow-sm flex flex-col">
                  <img src="${photoUrl}" class="w-full object-cover object-top aspect-square" alt="${agent.full_name}" />
                  <div class="p-3">
                    <h3 class="font-semibold text-base">${agent.full_name}</h3>
                    <p class="text-sm text-yellow-500"><i class="fas fa-star"></i> ${agent.rating || '4.5'}</p>
                    <p class="text-xs text-gray-800">${agent.category || 'Agent'}</p>
                    <button class="mt-2 bg-blue-600 text-white rounded-md py-1 px-4 text-sm w-full">View Profile</button>
                  </div>
                </article>`;
        }
      }
    
      loadFeaturedAgents(); // Call the renamed function
      loadRandomAgents();   // Call the new function
    });
  </script>
</body>
</html>
