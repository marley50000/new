<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Spark Ghana</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { opacity: 0; transform: translateY(20px); animation: fadeInUp 1s ease-out forwards; }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-[#ffff] min-h-screen p-4">
  <main class="max-w-7xl mx-auto fade-in">
    <h1 class="text-3xl font-bold text-center mb-6">Find verified agents in Ghana</h1>

    <!-- Button to Register as Agent -->
    <div class="text-center mb-8">
      <a href="Registration As Agent.html" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        <svg class="-ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" />
        </svg>
        Become an Agent
      </a>
    </div>

    <!-- Search Bar -->
    <form class="max-w-md mx-auto relative mb-10">
      <a id="postRequestToggle" href="#" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        <svg class="-ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        Post a Request
      </a>
      <!-- New button for My Requests -->
      <a id="myRequestsToggle" href="#" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 mt-4">
        <i class="fas fa-history mr-3 h-5 w-5"></i>
        My Posted Requests
      </a>
    </form>

    <!-- Post Request Form Container (initially hidden) -->
    <div id="postRequestFormContainer" class="hidden max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-lg mb-10">
      <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">Post Your Request</h2>
      <p class="text-center text-gray-600 mb-8">Tell us what you need, and agents will reach out to you!</p>

      <form id="requestForm" class="space-y-6">
        <div>
          <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Request Title</label>
          <input type="text" id="title" name="title" required placeholder="e.g., Need a 2-bedroom apartment in Accra"
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category of Service Needed</label>
          <select id="category" name="category" required
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="" disabled selected>Select a category</option>
              <option value="Rentals">Rentals/House Agents</option>
              <option value="Insurance">Insurance</option>
              <option value="Legal Help">Legal Help</option>
              <option value="Visa">Visa</option>
              <option value="Real Estate">Real Estate</option>
              <option value="Financial Services">Financial Services</option>
              <option value="Education">Education</option>
              <option value="Healthcare">Healthcare</option>
              <option value="Travel">Travel</option>
              <option value="Other">Other</option>
          </select>
        </div>

        <div>
          <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Detailed Description</label>
          <textarea id="description" name="description" rows="5" required placeholder="Provide details about your request, e.g., preferred location, budget range, specific requirements."
                    class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
        </div>

        <div>
          <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Preferred Location (Optional)</label>
          <input type="text" id="location" name="location" placeholder="e.g., East Legon, Accra"
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="budget" class="block text-sm font-medium text-gray-700 mb-1">Budget (GH₵ - Optional)</label>
          <input type="number" id="budget" name="budget" placeholder="e.g., 1500"
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="contactName" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
          <input type="text" id="contactName" name="contactName" required placeholder="Your full name"
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="contactEmail" class="block text-sm font-medium text-gray-700 mb-1">Your Email</label>
          <input type="email" id="contactEmail" name="contactEmail" required placeholder="your@example.com"
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="contactPhone" class="block text-sm font-medium text-gray-700 mb-1">Your Phone Number</label>
          <input type="tel" id="contactPhone" name="contactPhone" required placeholder="+233 24 123 4567"
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <button type="submit" id="submitBtn"
                class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          Post Request
        </button>
      </form>

      <div id="successMessage" class="hidden mt-6 p-4 bg-green-100 text-green-800 rounded-md text-center">
        Your request has been posted successfully! Agents will contact you ASAP...
      </div>
      <div id="errorMessage" class="hidden mt-6 p-4 bg-red-100 text-red-800 rounded-md text-center">
        An error occurred. Please try again.
      </div>
    </div>

    <!-- Categories -->
    <div class="flex flex-wrap justify-center gap-4 mb-8">
      <button class="category-btn"><i class="fas fa-home text-blue-600 text-2xl"></i><br>Rentals</button>
      <button class="category-btn"><i class="fas fa-shield-alt text-blue-600 text-2xl"></i><br>Insurance</button>
      <button class="category-btn"><i class="fas fa-gavel text-blue-600 text-2xl"></i><br>Legal Help</button>
      <button class="category-btn"><i class="fas fa-passport text-blue-600 text-2xl"></i><br>Visa</button>
      <button class="category-btn"><span class="text-2xl font-bold">...</span><br>Others</button>
    </div>

    <!-- Featured Agents -->
    <section class="bg-white rounded-3xl p-6 mb-10 shadow-md">
      <h2 class="text-xl font-semibold mb-6 flex items-center">
        Verified Agents
        <span class="ml-2 inline-flex items-center justify-center w-5 h-5 bg-green-500 text-white rounded-full">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
        </span>
      </h2>
      
      <div id="featured-agents-container" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-6"></div>
      <p id="featured-loading" class="text-center text-gray-500 mt-4">Verified agents...</p>
    </section>

    <!-- New Section for Random Agents -->
    <section class="bg-white rounded-3xl p-6 mb-10 shadow-md">
      <h2 class="text-xl font-semibold mb-6">Other Agents You Might Like</h2>
      <div id="random-agents-container" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-6"></div>
      <p id="random-loading" class="text-center text-gray-500 mt-4">Loading other agents...</p>
    </section>

    <!-- New Section for My Requests (initially hidden) -->
    <div id="myRequestsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 shadow-xl relative">
        <button id="closeMyRequestsModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">My Posted Requests</h2>
        <div id="my-requests-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-96 overflow-y-auto pr-2"></div>
        <p id="my-requests-loading" class="text-center text-gray-500 mt-4">Loading your requests...</p>
        <p id="my-requests-empty" class="hidden text-center text-gray-500 mt-4">You haven't posted any requests yet.</p>
      </div>
    </div>

    <!-- Why Choose Section -->
    <section class="flex flex-wrap justify-around items-center bg-white p-6 rounded-3xl shadow-md">
      <h3 class="text-xl font-semibold w-full text-center mb-4">Why Choose Verified Agents?</h3>
      <div class="flex flex-wrap justify-center gap-6 w-full">
        <div class="flex items-center gap-2 text-sm font-medium text-gray-700">
          <i class="fas fa-user-check text-blue-600"></i> Verified Professionals
        </div>
        <div class="flex items-center gap-2 text-sm font-medium text-gray-700">
          <i class="fas fa-thumbs-up text-blue-600"></i> Trusted by Users
        </div>
        <div class="flex items-center gap-2 text-sm font-medium text-gray-700">
          <i class="fas fa-shield-alt text-blue-600"></i> Peace of Mind
        </div>
      </div>
    </section>
  </main>

  <!-- Request Details Modal -->
  <div id="requestDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-xl relative">
      <button id="closeRequestDetailsModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
      <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-gray-800"></h2>
      <p class="text-gray-700 mb-2"><strong class="text-gray-900">Category:</strong> <span id="modalCategory"></span></p>
      <p class="text-gray-700 mb-2"><strong class="text-gray-900">Description:</strong> <span id="modalDescription"></span></p>
      <p class="text-gray-700 mb-2"><strong class="text-gray-900">Location:</strong> <span id="modalLocation"></span></p>
      <p class="text-gray-700 mb-2"><strong class="text-gray-900">Budget:</strong> <span id="modalBudget"></span></p>
      <p class="text-gray-700 mb-2"><strong class="text-gray-900">Status:</strong> <span id="modalStatus"></span></p>
      <p class="text-gray-700 mb-2"><strong class="text-gray-900">Posted On:</strong> <span id="modalPostedDate"></span></p>
      <div class="mt-4 pt-4 border-t border-gray-200">
        <h3 class="text-lg font-semibold mb-2 text-gray-800">Contact Information:</h3>
        <p class="text-gray-700 mb-1"><strong class="text-gray-900">Name:</strong> <span id="modalContactName"></span></p>
        <p class="text-gray-700 mb-1"><strong class="text-gray-900">Email:</strong> <span id="modalContactEmail"></span></p>
        <p class="text-gray-700"><strong class="text-gray-900">Phone:</strong> <span id="modalContactPhone"></span></p>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const supabaseUrl = 'https://qzddjvloicjwshggzctt.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZGRqdmxvaWNqd3NoZ2d6Y3R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MDk5MzMsImV4cCI6MjA2NDk4NTkzM30.mkrERrCanIkNnIlch5UJ-OOJ9az7oXs1EFZijkf7y7o'; // Add your real key here
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
      const storageBaseUrl = `${supabaseUrl}/storage/v1/object/public/agent-images/`;
      const userAuthSection = document.getElementById('user-auth-section');
    
      // Get references to the new elements
      const postRequestToggle = document.getElementById('postRequestToggle');
      const postRequestFormContainer = document.getElementById('postRequestFormContainer');

      // New: Reference to the "My Requests" section and its containers
      const myRequestsModal = document.getElementById('myRequestsModal'); // Changed from myRequestsSection
      const myRequestsContainer = document.getElementById('my-requests-container');
      const myRequestsLoading = document.getElementById('my-requests-loading');
      const myRequestsEmpty = document.getElementById('my-requests-empty');

      // New: References to modal elements
      const requestDetailsModal = document.getElementById('requestDetailsModal');
      const closeRequestDetailsModalBtn = document.getElementById('closeRequestDetailsModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalCategory = document.getElementById('modalCategory');
      const modalDescription = document.getElementById('modalDescription');
      const modalLocation = document.getElementById('modalLocation');
      const modalBudget = document.getElementById('modalBudget');
      const modalStatus = document.getElementById('modalStatus');
      const modalPostedDate = document.getElementById('modalPostedDate');
      const modalContactName = document.getElementById('modalContactName');
      const modalContactEmail = document = document.getElementById('modalContactEmail');
      const modalContactPhone = document.getElementById('modalContactPhone');

      // New: Reference to the new toggle button for My Requests
      const myRequestsToggle = document.getElementById('myRequestsToggle');

      let currentUser = null; // New: Variable to store the logged-in user
      let allUserRequests = new Map(); // New: To store requests for easy lookup by ID

      // Add a flag to prevent multiple rapid clicks
      let isMyRequestsToggleProcessing = false;

      // Add event listener for the Post a Request button
      if (postRequestToggle && postRequestFormContainer) {
        postRequestToggle.addEventListener('click', (event) => {
          event.preventDefault(); // Prevent the default link behavior (navigating to a new page)
          postRequestFormContainer.classList.toggle('hidden'); // Toggle the 'hidden' class to show/hide the form
          // Hide my requests modal if it's open
          if (!myRequestsModal.classList.contains('hidden')) { // Changed from myRequestsSection
              myRequestsModal.classList.add('hidden'); // Changed from myRequestsSection
          }
          console.log('Post Request button clicked. Form visibility:', !postRequestFormContainer.classList.contains('hidden'));
        });
      }

      // New: Add event listener for the My Requests toggle button
      if (myRequestsToggle && myRequestsModal) { // Changed from myRequestsSection
          myRequestsToggle.addEventListener('click', async (event) => {
              event.preventDefault();

              if (isMyRequestsToggleProcessing) {
                  console.log('My Requests toggle already processing. Ignoring click.');
                  return; // Ignore subsequent clicks while processing
              }

              isMyRequestsToggleProcessing = true; // Set flag to true
              console.log('My Requests button clicked.');

              // Determine if the modal is currently hidden
              const isCurrentlyHidden = myRequestsModal.classList.contains('hidden'); // Changed from myRequestsSection
              console.log('Initial state of My Requests modal (hidden class present):', isCurrentlyHidden);

              // Hide post request form if it's open
              if (!postRequestFormContainer.classList.contains('hidden')) {
                  postRequestFormContainer.classList.add('hidden');
                  console.log('Post Request form hidden.');
              }

              if (isCurrentlyHidden) {
                  // If currently hidden, show it
                  myRequestsModal.classList.remove('hidden'); // Changed from myRequestsSection
                  console.log('My Requests modal is now visible. Current classes:', myRequestsModal.classList.value); // Changed from myRequestsSection

                  if (currentUser) {
                      console.log('User is logged in. Loading requests...');
                      // Add visual feedback for loading
                      const originalButtonContent = myRequestsToggle.innerHTML;
                      myRequestsToggle.innerHTML = `
                          <div class="flex items-center justify-center gap-2">
                              <div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                              Loading...
                          </div>
                      `;
                      // Temporarily disable pointer events to prevent clicks
                      myRequestsToggle.style.pointerEvents = 'none';

                      try {
                          await loadMyRequests(currentUser.id);
                      } finally {
                          // Restore button state
                          myRequestsToggle.innerHTML = originalButtonContent;
                          myRequestsToggle.style.pointerEvents = 'auto';
                      }
                  } else {
                      alert("Please log in to view your posted requests.");
                      myRequestsModal.classList.add('hidden'); // Changed from myRequestsSection
                      console.log('User not logged in. My Requests modal hidden. Current classes:', myRequestsModal.classList.value); // Changed from myRequestsSection
                  }
              } else {
                  // If currently visible, hide it
                  myRequestsModal.classList.add('hidden'); // Changed from myRequestsSection
                  console.log('My Requests modal is now hidden. Current classes:', myRequestsModal.classList.value); // Changed from myRequestsSection
              }

              isMyRequestsToggleProcessing = false; // Reset flag after processing
          });
      }

      // --- Start of new code for form submission ---
      const requestForm = document.getElementById('requestForm');
      const submitBtn = document.getElementById('submitBtn');
      const successMessage = document.getElementById('successMessage');
      const errorMessage = document.getElementById('errorMessage');

      if (requestForm) { // Ensure the form exists before adding listener
        requestForm.addEventListener('submit', async function(event) {
          event.preventDefault();

          if (!currentUser) { // New: Check if user is logged in before submitting
            errorMessage.textContent = "Please log in to post a request.";
            errorMessage.classList.remove('hidden');
            console.log('Form submission blocked: User not logged in.');
            return;
          }

          submitBtn.innerHTML = `
            <div class="flex items-center gap-2">
              <div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
              Posting...
            </div>
          `;
          submitBtn.disabled = true;
          successMessage.classList.add('hidden');
          errorMessage.classList.add('hidden');

          const formData = new FormData(requestForm);
          const requestData = {
            title: formData.get('title'),
            category: formData.get('category'),
            description: formData.get('description'),
            location: formData.get('location'),
            budget: formData.get('budget') ? parseFloat(formData.get('budget')) : null, // Convert to number or null
            contact_name: formData.get('contactName'),
            contact_email: formData.get('contactEmail'),
            contact_phone: formData.get('contactPhone'),
            status: 'open', // Default status for new requests
            user_id: currentUser.id // This line ensures the user's ID is included
          };

          console.log("Submitting request data:", requestData); // New: Log the data being sent

          try {
            const { data, error } = await supabase
              .from('user_requests') // This is the new table name
              .insert([requestData]);

            if (error) {
              throw new Error(error.message);
            }

            successMessage.classList.remove('hidden');
            requestForm.reset(); // Clear the form

            // Optionally hide the form after successful submission
            postRequestFormContainer.classList.add('hidden');

            // New: Reload user requests after a successful submission
            loadMyRequests(currentUser.id);
            console.log('Request posted successfully. Reloading my requests.');

            // You can remove the redirect if you prefer to stay on the homepage
            // setTimeout(() => {
            //   window.location.reload(); // Reload page to reflect changes or just stay
            // }, 3000);

          } catch (error) {
            console.error("Error posting request:", error);
            errorMessage.textContent = "An error occurred: " + error.message;
            errorMessage.classList.remove('hidden');
          } finally {
            submitBtn.innerHTML = 'Post Request';
            submitBtn.disabled = false;
          }
        });
      }
      // --- End of new code for form submission ---

      async function checkUserAndDisplayAuth() {
        const { data: { user }, error } = await supabase.auth.getUser();
    
        if (error) {
          console.error("Error getting user:", error.message);
          // Optionally display a login/signup link if there's an error or no user
          userAuthSection.innerHTML = `<a href="#" class="text-blue-600 hover:underline text-sm">Login / Sign Up</a>`;
          myRequestsModal.classList.add('hidden'); // Changed from myRequestsSection
          currentUser = null; // Ensure currentUser is null
          console.log('No user found or error getting user. currentUser set to null.');
          return;
        }
    
        if (user) {
          currentUser = user; // New: Store the user object
          const userName = user.user_metadata?.full_name || user.email;
          userAuthSection.innerHTML = `
            <span class="text-gray-700 text-sm mr-2">Welcome, ${userName}!</span>
            <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-3 rounded-md">Logout</button>
          `;
          document.getElementById('logoutButton').addEventListener('click', async () => {
            const { error: signOutError } = await supabase.auth.signOut();
            if (signOutError) {
              console.error("Error signing out:", signOutError.message);
            } else {
              window.location.reload(); // Reload page to reflect logged out state
            }
          });
          console.log('User logged in:', userName, 'ID:', currentUser.id);
          // myRequestsModal.classList.remove('hidden'); // REMOVED: Visibility now controlled by toggle button
          // loadMyRequests(currentUser.id); // REMOVED: Loading now controlled by toggle button
        } else {
          // If no user is logged in, display a login/signup link
          userAuthSection.innerHTML = `<a href="#" class="text-blue-600 hover:underline text-sm">Login / Sign Up</a>`;
          myRequestsModal.classList.add('hidden'); // Changed from myRequestsSection
          currentUser = null; // Ensure currentUser is null
          console.log('No user logged in. currentUser set to null.');
        }
      }
    
      // Call this function when the page loads to check user status
      checkUserAndDisplayAuth();

      // New: Function to display request details in the modal
      function displayRequestDetailsModal(request) {
          modalTitle.textContent = request.title;
          modalCategory.textContent = request.category;
          modalDescription.textContent = request.description;
          modalLocation.textContent = request.location || 'N/A';
          modalBudget.textContent = request.budget ? `GH₵ ${request.budget.toLocaleString()}` : 'N/A';
          modalStatus.textContent = request.status;
          modalStatus.className = `font-medium ${request.status === 'open' ? 'text-green-600' : 'text-red-600'}`; // Apply status color
          modalPostedDate.textContent = new Date(request.created_at).toLocaleDateString();
          modalContactName.textContent = request.contact_name;
          modalContactEmail.textContent = request.contact_email;
          modalContactPhone.textContent = request.contact_phone;
          requestDetailsModal.classList.remove('hidden');
          console.log('Displaying request details modal for request ID:', request.id);
      }

      // New: Function to close the request details modal
      function closeRequestDetailsModal() {
          requestDetailsModal.classList.add('hidden');
          console.log('Request details modal closed.');
      }

      // New: Event listeners for closing the modal
      closeRequestDetailsModalBtn.addEventListener('click', closeRequestDetailsModal);
      requestDetailsModal.addEventListener('click', (event) => {
          if (event.target === requestDetailsModal) { // Close if clicking on the overlay
              closeRequestDetailsModal();
          }
      });

      // New: Function to close the My Requests modal
      const closeMyRequestsModalBtn = document.getElementById('closeMyRequestsModal');
      closeMyRequestsModalBtn.addEventListener('click', () => {
          myRequestsModal.classList.add('hidden');
          console.log('My Requests modal closed.');
      });

      myRequestsModal.addEventListener('click', (event) => {
          if (event.target === myRequestsModal) { // Close if clicking on the overlay
              myRequestsModal.classList.add('hidden');
              console.log('My Requests modal closed by overlay click.');
          }
      });

      // New: Function to load and display user's requests
      async function loadMyRequests(userId) {
        console.log('Attempting to load requests for user ID:', userId);
        myRequestsContainer.innerHTML = ''; // Clear previous requests
        myRequestsLoading.classList.remove('hidden'); // Show loading message
        myRequestsEmpty.classList.add('hidden'); // Hide empty message
        allUserRequests.clear(); // Clear previous requests from map

        const { data, error } = await supabase
          .from('user_requests')
          .select('*')
          .eq('user_id', userId) // Filter by the current user's ID
          .order('created_at', { ascending: false }); // Show newest first

        myRequestsLoading.classList.add('hidden'); // Hide loading message

        if (error) {
          console.error("Error loading user requests:", error.message);
          myRequestsContainer.innerHTML = `<p class="text-center text-red-500">Failed to load your requests.</p>`;
          return;
        }

        console.log('Supabase response for user requests:', data);

        if (data.length === 0) {
          myRequestsEmpty.classList.remove('hidden'); // Show empty message
          console.log('No requests found for this user.');
          return;
        }

        data.forEach(request => {
          allUserRequests.set(request.id, request); // Store request in map for easy lookup
          myRequestsContainer.innerHTML += `
            <article class="bg-[#f7f9fc] rounded-xl p-4 shadow-sm flex flex-col">
              <h3 class="font-semibold text-lg text-gray-800">${request.title}</h3>
              <p class="text-sm text-gray-600 mb-2">${request.category}</p>
              <p class="text-sm text-gray-700 mb-3">${request.description.substring(0, 100)}${request.description.length > 100 ? '...' : ''}</p>
              <div class="flex justify-between items-center text-xs text-gray-500">
                <span>Location: ${request.location || 'N/A'}</span>
                <span>Budget: GH₵ ${request.budget ? request.budget.toLocaleString() : 'N/A'}</span>
              </div>
              <div class="flex justify-between items-center text-xs text-gray-500 mt-1">
                <span>Status: <span class="font-medium ${request.status === 'open' ? 'text-green-600' : 'text-red-600'}">${request.status}</span></span>
                <span>Posted: ${new Date(request.created_at).toLocaleDateString()}</span>
              </div>
              <button class="mt-4 bg-blue-600 hover:bg-blue-700 text-white rounded-md py-2 px-4 text-sm view-details-btn" data-request-id="${request.id}">View Details</button>
            </article>
          `;
        });
        console.log('Requests rendered to container.');

        // Attach event listeners to the newly created "View Details" buttons
        document.querySelectorAll('.view-details-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                const requestId = event.target.dataset.requestId;
                console.log('View Details button clicked for request ID:', requestId); // Added for debugging
                const request = allUserRequests.get(requestId);
                if (request) {
                    displayRequestDetailsModal(request);
                } else {
                    console.error('Request not found in map for ID:', requestId); // Added for debugging
                }
            });
        });
      }

      // Utility function to shuffle an array (Fisher-Yates algorithm)
      function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]]; // Swap elements
          }
          return array;
      }
    
      async function loadFeaturedAgents() { // Renamed from loadAgents
        const { data, error } = await supabase
            .from('agents')
            .select('*')
            .order('is_featured', { ascending: false })  // show featured first
            .order('created_at', { ascending: false });   // then newest first

        const container = document.getElementById('featured-agents-container'); // Updated ID
        const loading = document.getElementById('featured-loading'); // Updated ID
    
        if (error || !data) {
            loading.textContent = "Failed to load featured agents.";
            return;
        }
    
        container.innerHTML = '';
        loading.style.display = 'none';

        // Filter to only display agents explicitly marked as featured
        const featuredAgents = data.filter(agent => agent.is_featured);

        if (featuredAgents.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 col-span-full">No featured agents available at the moment.</p>';
            return;
        }
    
        for (const agent of featuredAgents) { // Iterate over filtered featuredAgents
          let photoUrl = 'https://via.placeholder.com/300';
          if (agent.photo_path) {
            // Ensure photo_path doesn't duplicate the bucket name already in storageBaseUrl
            const cleanedPath = agent.photo_path.startsWith('agent-images/')
                ? agent.photo_path.replace('agent-images/', '')
                : agent.photo_path;
            photoUrl = `${storageBaseUrl}${cleanedPath}`;
          }
    
          container.innerHTML += `
            <article class="bg-[#f7f9fc] rounded-xl overflow-hidden shadow-sm flex flex-col">
              <img src="${photoUrl}" class="w-full object-cover object-top aspect-square" alt="${agent.full_name}" />
              <div class="p-3">
                <h3 class="font-semibold text-base">${agent.full_name}</h3>
               <p class="text-sm text-green-500 flex items-center">
  <span class="inline-flex items-center justify-center w-5 h-5 bg-green-500 text-white rounded-full mr-1">
    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.09 3.36h3.53c.969 0 1.371 1.24.588 1.81l-2.857 2.073 1.09 3.36c.3.922-.755 1.688-1.54 1.118L10 12.347l-2.857 2.073c-.784.57-1.838-.196-1.539-1.118l1.09-3.36-2.857-2.073c-.784-.57-.38-1.81.588-1.81h3.53l1.09-3.36z"/>
    </svg>
  </span>
  ${agent.rating || '4.5'}
</p>

                <p class="text-xs text-gray-800">${agent.category || 'Agent'}</p>
                <button class="mt-2 bg-blue-900 hover:bg-green-600 text-white rounded-md py-1 px-4 text-sm w-full">
  View Profile
</button>

              </div>
            </article>`;
        }
      }

      async function loadRandomAgents() {
        const { data, error } = await supabase
            .from('agents')
            .select('*')
            .eq('is_featured', false) // Only get non-featured agents
            .limit(20); // Fetch a reasonable number to shuffle from

        const container = document.getElementById('random-agents-container');
        const loading = document.getElementById('random-loading');

        if (error || !data) {
            loading.textContent = "Failed to load other agents.";
            return;
        }

        container.innerHTML = '';
        loading.style.display = 'none';

        if (data.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 col-span-full">No other agents available at the moment.</p>';
            return;
        }

        const shuffledAgents = shuffleArray(data).slice(0, 8); // Shuffle and take up to 8 random agents

        for (const agent of shuffledAgents) {
            let photoUrl = 'https://via.placeholder.com/300';
            if (agent.photo_path) {
                // Ensure photo_path doesn't duplicate the bucket name already in storageBaseUrl
                const cleanedPath = agent.photo_path.startsWith('agent-images/')
                    ? agent.photo_path.replace('agent-images/', '')
                    : agent.photo_path;
                photoUrl = `${storageBaseUrl}${cleanedPath}`;
            }

            container.innerHTML += `
                <article class="bg-[#f7f9fc] rounded-xl overflow-hidden shadow-sm flex flex-col">
                  <img src="${photoUrl}" class="w-full object-cover object-top aspect-square" alt="${agent.full_name}" />
                  <div class="p-3">
                    <h3 class="font-semibold text-base">${agent.full_name}</h3>
                    <p class="text-sm text-yellow-500"><i class="fas fa-star"></i> ${agent.rating || '4.5'}</p>
                    <p class="text-xs text-gray-800">${agent.category || 'Agent'}</p>
                    <button class="mt-2 bg-blue-600 text-white rounded-md py-1 px-4 text-sm w-full">View Profile</button>
                  </div>
                </article>`;
        }
      }
    
      loadFeaturedAgents(); // Call the renamed function
      loadRandomAgents();   // Call the new function
    });
  </script>
</body>
</html>
