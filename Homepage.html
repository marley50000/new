<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Spark Ghana</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { opacity: 0; transform: translateY(20px); animation: fadeInUp 1s ease-out forwards; }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
    /* New CSS for the toggle switch */
    .toggle-post-status:checked + .block {
        background-color: #22C55E; /* green-500 */
    }
    .toggle-post-status:checked + .block + .dot {
        transform: translateX(100%);
    }
  </style>
</head>

<body class="bg-[#ffff] min-h-screen p-4">
  <main class="max-w-7xl mx-auto fade-in">
    <!-- User authentication status -->
    <div id="user-auth-section" class="text-right mb-4">
      <!-- Content will be dynamically loaded by JavaScript -->
    </div>

    <h1 class="text-3xl font-bold text-center mb-6">Find verified agents in Ghana</h1>

    <!-- Button to Register as Agent -->
    <div class="text-center mb-8">
      <a href="Registration As Agent.html" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        <svg class="-ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z" />
        </svg>
        Become an Agent
      </a>
    </div>

    <!-- Search Bar and Request Buttons -->
    <form class="max-w-md mx-auto relative mb-10">
      <a id="postRequestToggle" href="#" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        <svg class="-ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        Post a Request
      </a>
      <!-- Button for My Requests -->
      <a id="myRequestsToggle" href="#" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 mt-4">
        <i class="fas fa-history mr-3 h-5 w-5"></i>
        My Posted Requests
      </a>
      <!-- Button for Open Requests from Other Users -->
      <a id="viewOpenRequestsButton" href="#" class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 mt-4 relative">
        <i class="fas fa-comments mr-3 h-5 w-5"></i>
        Open Requests
        <span id="openRequestsCountBadge" class="absolute top-0 right-0 -mt-2 -mr-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full hidden"></span>
      </a>
    </form>

    <!-- Post Request Form Container (initially hidden) -->
    <div id="postRequestFormContainer" class="hidden max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-lg mb-10">
      <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">Post Your Request</h2>
      <p class="text-center text-gray-600 mb-8">Tell us what you need, and agents will reach out to you!</p>

      <form id="requestForm" class="space-y-6">
        <div>
          <label for="title" class="block text-sm font-medium text-gray-700 mb-1">Request Title</label>
          <input type="text" id="title" name="title" required placeholder="e.g., Need a 2-bedroom apartment in Accra"
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category of Service Needed</label>
          <select id="category" name="category" required
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="" disabled selected>Select a category</option>
              <option value="Rentals">Rentals/House Agents</option>
              <option value="Insurance">Insurance</option>
              <option value="Legal Help">Legal Help</option>
              <option value="Visa">Visa</option>
              <option value="Real Estate">Real Estate</option>
              <option value="Financial Services">Financial Services</option>
              <option value="Education">Education</option>
              <option value="Healthcare">Healthcare</option>
              <option value="Travel">Travel</option>
              <option value="Other">Other</option>
          </select>
        </div>

        <div>
          <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Detailed Description</label>
          <textarea id="description" name="description" rows="5" required placeholder="Provide details about your request, e.g., preferred location, budget range, specific requirements."
                    class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
        </div>

        <div>
          <label for="location" class="block text-sm font-medium text-gray-700 mb-1">Preferred Location (Optional)</label>
          <input type="text" id="location" name="location" placeholder="e.g., East Legon, Accra"
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="budget" class="block text-sm font-medium text-gray-700 mb-1">Budget (GHâ‚µ - Optional)</label>
          <input type="number" id="budget" name="budget" placeholder="e.g., 1500"
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="contactName" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
          <input type="text" id="contactName" name="contactName" required placeholder="Your full name"
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="contactEmail" class="block text-sm font-medium text-gray-700 mb-1">Your Email</label>
          <input type="email" id="contactEmail" name="contactEmail" required placeholder="your@example.com"
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div>
          <label for="contactPhone" class="block text-sm font-medium text-gray-700 mb-1">Your Phone Number</label>
          <input type="tel" id="contactPhone" name="contactPhone" required placeholder="+233 24 123 4567"
                 class="h-11 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>

        <button type="submit" id="submitBtn"
                class="w-full inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          Post Request
        </button>
      </form>

      <div id="successMessage" class="hidden mt-6 p-4 bg-green-100 text-green-800 rounded-md text-center">
        Your request has been posted successfully! Agents will contact you ASAP...
      </div>
      <div id="errorMessage" class="hidden mt-6 p-4 bg-red-100 text-red-800 rounded-md text-center">
        An error occurred. Please try again.
      </div>
    </div>

    <!-- New Section for All Open Requests -->
    <section id="all-open-requests-section" class="bg-white rounded-3xl p-6 mb-10 shadow-md hidden">
      <h2 class="text-xl font-semibold mb-6">Open Requests from Other Users</h2>
      <div id="all-requests-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
      <p id="all-requests-loading" class="text-center text-gray-500 mt-4">Loading open requests...</p>
      <p id="all-requests-empty" class="hidden text-center text-gray-500 mt-4">No open requests available at the moment.</p>
    </section>

    <!-- New Section for My Requests (initially hidden) -->
    <div id="myRequestsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-start justify-center z-50 hidden pt-10">
      <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 shadow-xl relative">
        <button id="closeMyRequestsModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
        <h2 class="text-2xl font-semibold mb-6 text-gray-800">My Posted Requests</h2>
        <div id="my-requests-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-96 overflow-y-auto pr-2"></div>
        <p id="my-requests-loading" class="text-center text-gray-500 mt-4">Loading your requests...</p>
        <p id="my-requests-empty" class="hidden text-center text-gray-500 mt-4">You haven't posted any requests yet.</p>
      </div>
    </div>

    <!-- Categories -->
    <div class="flex flex-wrap justify-center gap-4 mb-8">
      <button class="category-btn"><i class="fas fa-home text-blue-600 text-2xl"></i><br>Rentals</button>
      <button class="category-btn"><i class="fas fa-shield-alt text-blue-600 text-2xl"></i><br>Insurance</button>
      <button class="category-btn"><i class="fas fa-gavel text-blue-600 text-2xl"></i><br>Legal Help</button>
      <button class="category-btn"><i class="fas fa-passport text-blue-600 text-2xl"></i><br>Visa</button>
      <button class="category-btn"><span class="text-2xl font-bold">...</span><br>Others</button>
    </div>

    <!-- Featured Agents -->
    <section class="bg-white rounded-3xl p-6 mb-10 shadow-md">
      <h2 class="text-xl font-semibold mb-6 flex items-center">
        Verified Agents
        <span class="ml-2 inline-flex items-center justify-2 w-5 h-5 bg-green-500 text-white rounded-full">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
        </span>
      </h2>
      
      <div id="featured-agents-container" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-6"></div>
      <p id="featured-loading" class="text-center text-gray-500 mt-4">Verified agents...</p>
    </section>

    <!-- New Section for Random Agents -->
    <section class="bg-white rounded-3xl p-6 mb-10 shadow-md">
      <h2 class="text-xl font-semibold mb-6">Other Agents You Might Like</h2>
      <div id="random-agents-container" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-6"></div>
      <p id="random-loading" class="text-center text-gray-500 mt-4">Loading other agents...</p>
    </section>

    <!-- Why Choose Section -->
    <section class="flex flex-wrap justify-around items-center bg-white p-6 rounded-3xl shadow-md">
      <h3 class="text-xl font-semibold w-full text-center mb-4">Why Choose Verified Agents?</h3>
      <div class="flex flex-wrap justify-center gap-6 w-full">
        <div class="flex items-center gap-2 text-sm font-medium text-gray-700">
          <i class="fas fa-user-check text-blue-600"></i> Verified Professionals
        </div>
        <div class="flex items-center gap-2 text-sm font-medium text-gray-700">
          <i class="fas fa-thumbs-up text-blue-600"></i> Trusted by Users
        </div>
        <div class="flex items-center gap-2 text-sm font-medium text-gray-700">
          <i class="fas fa-shield-alt text-blue-600"></i> Peace of Mind
        </div>
      </div>
    </section>
  </main>

  <!-- Request Details Modal -->
  <div id="requestDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-xl relative">
      <button id="closeRequestDetailsModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
      <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-gray-800"></h2>
      <p class="text-gray-700 mb-2"><strong class="text-gray-900">Category:</strong> <span id="modalCategory"></span></p>
      <p class="text-gray-700 mb-2"><strong class="text-gray-900">Description:</strong> <span id="modalDescription"></span></p>
      <p class="text-gray-700 mb-2"><strong class="text-gray-900">Location:</strong> <span id="modalLocation"></span></p>
      <p class="text-gray-700 mb-2"><strong class="text-gray-900">Budget:</strong> <span id="modalBudget"></span></p>
      <p class="text-gray-700 mb-2"><strong class="text-gray-900">Status:</strong> <span id="modalStatus"></span></p>
      <p class="text-gray-700 mb-2"><strong class="text-gray-900">Posted On:</strong> <span id="modalPostedDate"></span></p>
      <div class="mt-4 pt-4 border-t border-gray-200">
        <h3 class="text-lg font-semibold mb-2 text-gray-800">Contact Information:</h3>
        <p class="text-gray-700 mb-1"><strong class="text-gray-900">Name:</strong> <span id="modalContactName"></span></p>
        <p class="text-gray-700 mb-1"><strong class="text-gray-900">Email:</strong> <span id="modalContactEmail"></span></p>
        <p class="text-gray-700"><strong class="text-gray-900">Phone:</strong> <span id="modalContactPhone"></span></p>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const supabaseUrl = 'https://qzddjvloicjwshggzctt.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6ZGRqdmxvaWNqd3NoZ2d6Y3R0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MDk5MzMsImV4cCI6MjA2NDk4NTkzM30.mkrERrCanIkNnIlch5UJ-OOJ9az7oXs1EFZijkf7y7o';
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
      const storageBaseUrl = `${supabaseUrl}/storage/v1/object/public/agent-images/`;
      const userAuthSection = document.getElementById('user-auth-section');
    
      // Supabase Realtime subscription for user_requests
      supabase
        .channel('public:user_requests')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'user_requests' }, payload => {
          console.log('Realtime change received for user_requests:', payload);
          loadAllOpenRequests();
          // If the change is for the current user's request, also reload their requests
          if (currentUser && payload.new && payload.new.user_id === currentUser.id) {
              loadMyRequests(currentUser.id);
          }
        })
        .subscribe();

      // Get references to elements
      const postRequestToggle = document.getElementById('postRequestToggle');
      const postRequestFormContainer = document.getElementById('postRequestFormContainer');
      const myRequestsModal = document.getElementById('myRequestsModal');
      const myRequestsContainer = document.getElementById('my-requests-container');
      const myRequestsLoading = document.getElementById('my-requests-loading');
      const myRequestsEmpty = document.getElementById('my-requests-empty');
      const requestDetailsModal = document.getElementById('requestDetailsModal');
      const closeRequestDetailsModalBtn = document.getElementById('closeRequestDetailsModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalCategory = document.getElementById('modalCategory');
      const modalDescription = document.getElementById('modalDescription');
      const modalLocation = document.getElementById('modalLocation');
      const modalBudget = document.getElementById('modalBudget');
      const modalStatus = document.getElementById('modalStatus');
      const modalPostedDate = document.getElementById('modalPostedDate');
      const modalContactName = document.getElementById('modalContactName');
      const modalContactEmail = document.getElementById('modalContactEmail');
      const modalContactPhone = document.getElementById('modalContactPhone');
      const myRequestsToggle = document.getElementById('myRequestsToggle');
      const viewOpenRequestsButton = document.getElementById('viewOpenRequestsButton');
      const allOpenRequestsSection = document.getElementById('all-open-requests-section');
      const openRequestsCountBadge = document.getElementById('openRequestsCountBadge');

      let currentUser = null;
      let allUserRequests = new Map();
      let allOpenRequestsMap = new Map();
      let isMyRequestsToggleProcessing = false;
      let currentChatRequestId = null;
      let currentChatRecipientId = null;
      let currentChatRecipientName = null;
      let isChatMinimized = false;

      // Add event listener for the Post a Request button
      if (postRequestToggle && postRequestFormContainer) {
          postRequestToggle.addEventListener('click', (event) => {
              event.preventDefault();
              const isFormCurrentlyHidden = postRequestFormContainer.classList.contains('hidden');
              postRequestFormContainer.classList.toggle('hidden');
              
              if (isFormCurrentlyHidden) {
                  successMessage.classList.add('hidden');
                  errorMessage.classList.add('hidden');
              }
              
              if (!myRequestsModal.classList.contains('hidden')) {
                  myRequestsModal.classList.add('hidden');
              }
              if (!allOpenRequestsSection.classList.contains('hidden')) {
                  allOpenRequestsSection.classList.add('hidden');
              }
          });
      }

      // Add event listener for the My Requests toggle button
      if (myRequestsToggle && myRequestsModal) {
          myRequestsToggle.addEventListener('click', async (event) => {
              event.preventDefault();

              if (isMyRequestsToggleProcessing) {
                  return;
              }

              isMyRequestsToggleProcessing = true;
              
              const isCurrentlyHidden = myRequestsModal.classList.contains('hidden');

              if (!postRequestFormContainer.classList.contains('hidden')) {
                  postRequestFormContainer.classList.add('hidden');
              }
              if (!allOpenRequestsSection.classList.contains('hidden')) {
                  allOpenRequestsSection.classList.add('hidden');
              }

              if (isCurrentlyHidden) {
                  myRequestsModal.classList.remove('hidden');

                  if (currentUser) {
                      const originalButtonContent = myRequestsToggle.innerHTML;
                      myRequestsToggle.innerHTML = `
                          <div class="flex items-center justify-center gap-2">
                              <div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                              Loading...
                          </div>
                      `;
                      myRequestsToggle.style.pointerEvents = 'none';

                      try {
                          await loadMyRequests(currentUser.id);
                      } finally {
                          myRequestsToggle.innerHTML = originalButtonContent;
                          myRequestsToggle.style.pointerEvents = 'auto';
                      }
                  } else {
                      alert("Please log in to view your posted requests.");
                      myRequestsModal.classList.add('hidden');
                  }
              } else {
                  myRequestsModal.classList.add('hidden');
              }

              isMyRequestsToggleProcessing = false;
          });
      }

      // Add event listener for the "View Open Requests" button
      if (viewOpenRequestsButton && allOpenRequestsSection) {
          viewOpenRequestsButton.addEventListener('click', (event) => {
              event.preventDefault();
              allOpenRequestsSection.classList.toggle('hidden');
              
              if (!postRequestFormContainer.classList.contains('hidden')) {
                  postRequestFormContainer.classList.add('hidden');
              }
              if (!myRequestsModal.classList.contains('hidden')) {
                  myRequestsModal.classList.add('hidden');
              }
          });
      }

      // Form submission
      const requestForm = document.getElementById('requestForm');
      const submitBtn = document.getElementById('submitBtn');
      const successMessage = document.getElementById('successMessage');
      const errorMessage = document.getElementById('errorMessage');

      if (requestForm) {
          requestForm.addEventListener('submit', async function(event) {
              event.preventDefault();

              if (!currentUser) {
                  errorMessage.textContent = "Please log in to post a request.";
                  errorMessage.classList.remove('hidden');
                  return;
              }

              submitBtn.innerHTML = `
                  <div class="flex items-center gap-2">
                      <div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                      Posting...
                  </div>
              `;
              submitBtn.disabled = true;
              successMessage.classList.add('hidden');
              errorMessage.classList.add('hidden');

              const formData = new FormData(requestForm);
              const requestData = {
                  title: formData.get('title'),
                  category: formData.get('category'),
                  description: formData.get('description'),
                  location: formData.get('location'),
                  budget: formData.get('budget') ? parseFloat(formData.get('budget')) : null,
                  contact_name: formData.get('contactName'),
                  contact_email: formData.get('contactEmail'),
                  contact_phone: formData.get('contactPhone'),
                  status: 'open',
                  user_id: currentUser.id,
                  post_status: true // Set post_status to true by default
              };

              try {
                  const { data, error } = await supabase
                      .from('user_requests')
                      .insert([requestData]);

                  if (error) {
                      throw new Error(error.message);
                  }

                  successMessage.classList.remove('hidden');
                  requestForm.reset();
                  postRequestFormContainer.classList.add('hidden');
                  myRequestsModal.classList.remove('hidden');
                  loadMyRequests(currentUser.id);
                  loadAllOpenRequests();
              } catch (error) {
                  console.error("Error posting request:", error);
                  errorMessage.textContent = "An error occurred: " + error.message;
                  errorMessage.classList.remove('hidden');
              } finally {
                  submitBtn.innerHTML = 'Post Request';
                  submitBtn.disabled = false;
              }
          });
      }

      async function checkUserAndDisplayAuth() {
          const { data: { user }, error } = await supabase.auth.getUser();
      
          if (error) {
              console.error("Error getting user:", error.message);
              userAuthSection.innerHTML = `<a href="index.html" class="text-blue-600 hover:underline text-sm">Login / Sign Up</a>`;
              myRequestsModal.classList.add('hidden');
              currentUser = null;
              return;
          }
      
          if (user) {
              currentUser = user;
              const userName = user.user_metadata?.full_name || user.email;
              userAuthSection.innerHTML = `
                  <span class="text-gray-700 text-sm mr-2">Welcome, ${userName}!</span>
                  <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-3 rounded-md">Logout</button>
              `;
              document.getElementById('logoutButton').addEventListener('click', async () => {
                  const { error: signOutError } = await supabase.auth.signOut();
                  if (!signOutError) {
                      window.location.reload();
                  }
              });
          } else {
              userAuthSection.innerHTML = `<a href="index.html" class="text-blue-600 hover:underline text-sm">Login / Sign Up</a>`;
              myRequestsModal.classList.add('hidden');
              currentUser = null;
          }
      }

      function formatTimestamp(date) {
          return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      function displayRequestDetailsModal(request) {
          modalTitle.textContent = request.title;
          modalCategory.textContent = request.category;
          modalDescription.textContent = request.description;
          modalLocation.textContent = request.location || 'N/A';
          modalBudget.textContent = request.budget ? `GHâ‚µ ${request.budget.toLocaleString()}` : 'N/A';
          modalStatus.textContent = request.status;
          modalStatus.className = `font-medium ${request.status === 'open' ? 'text-green-600' : 'text-red-600'}`;
          modalPostedDate.textContent = new Date(request.created_at).toLocaleString();
          modalContactName.textContent = request.contact_name;
          modalContactEmail.textContent = request.contact_email;
          modalContactPhone.textContent = request.contact_phone;
          requestDetailsModal.classList.remove('hidden');
      }

      function closeRequestDetailsModal() {
          requestDetailsModal.classList.add('hidden');
      }

      closeRequestDetailsModalBtn.addEventListener('click', closeRequestDetailsModal);
      requestDetailsModal.addEventListener('click', (event) => {
          if (event.target === requestDetailsModal) {
              closeRequestDetailsModal();
          }
      });

      const closeMyRequestsModalBtn = document.getElementById('closeMyRequestsModal');
      closeMyRequestsModalBtn.addEventListener('click', () => {
          myRequestsModal.classList.add('hidden');
      });

      myRequestsModal.addEventListener('click', (event) => {
          if (event.target === myRequestsModal) {
              myRequestsModal.classList.add('hidden');
          }
      });

      async function loadMyRequests(userId) {
          console.log('Attempting to load requests for user ID:', userId);
          myRequestsContainer.innerHTML = '';
          myRequestsLoading.classList.remove('hidden');
          myRequestsEmpty.classList.add('hidden');
          allUserRequests.clear();
      
          const { data, error } = await supabase
              .from('user_requests')
              .select('*')
              .eq('user_id', userId)
              .order('created_at', { ascending: false });
      
          myRequestsLoading.classList.add('hidden');
      
          if (error) {
              console.error("Error loading user requests:", error.message);
              myRequestsContainer.innerHTML = `<p class="text-center text-red-500">Failed to load your requests.</p>`;
              return;
          }
      
          if (data.length === 0) {
              myRequestsEmpty.classList.remove('hidden');
              return;
          }
      
          // Use a temporary array to store HTML strings to avoid repeated DOM manipulation
          // and use Promise.all to wait for all async operations within the loop
          const requestHtmlPromises = data.map(async request => {
              allUserRequests.set(request.id, request);
      
              let chatButtonHtml = '';
              let agentIdForChat = null;
              let agentNameForChat = 'Agent'; // Default name for the agent
      
              // Try to find an agent ID from existing conversations for this request
              // We look for any message associated with this request_id
              const { data: conversationMessages, error: conversationError } = await supabase
                  .from('request_conversations')
                  .select('sender_id, receiver_id')
                  .eq('request_id', request.id)
                  .limit(1); // Just need one message to identify an agent
      
              if (conversationError) {
                  console.error("Error fetching conversation for request:", conversationError);
              }
      
              if (conversationMessages && conversationMessages.length > 0) {
                  const message = conversationMessages[0];
                  // Determine which ID is the agent's ID (the one that is not the current user's ID)
                  if (message.sender_id !== currentUser.id) {
                      agentIdForChat = message.sender_id;
                  } else if (message.receiver_id !== currentUser.id) {
                      agentIdForChat = message.receiver_id;
                  }
      
                  if (agentIdForChat) {
                      // Fetch agent's name from the 'agents' table
                      const { data: agentData, error: agentError } = await supabase
                          .from('agents')
                          .select('full_name')
                          .eq('id', agentIdForChat); // Removed .single()
                      if (agentError) {
                          console.error("Error fetching agent details:", agentError);
                      }
                      // Check if data exists and has elements before accessing
                      if (agentData && agentData.length > 0 && agentData[0].full_name) {
                          agentNameForChat = agentData[0].full_name;
                      }
                  }
              }
      
              if (agentIdForChat) {
                  // If an agent ID is found, create the "Chat with Agent" button
                  chatButtonHtml = `
                      <button class="mt-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md py-2 px-4 text-sm chat-with-agent-btn"
                              data-request-id="${request.id}"
                              data-user-id="${currentUser.id}"
                              data-agent-id="${agentIdForChat}"
                              data-agent-name="${agentNameForChat}">
                          Chat with ${agentNameForChat}
                      </button>
                  `;
              } else {
                  // If no agent ID is found (no conversation started yet), disable the button
                  chatButtonHtml = `
                      <button class="mt-2 bg-gray-400 text-white rounded-md py-2 px-4 text-sm cursor-not-allowed" disabled>
                          No Agent Chat Yet
                      </button>
                  `;
              }
      
              return `
                  <article class="bg-[#f7f9fc] rounded-xl p-4 shadow-sm flex flex-col">
                      <h3 class="font-semibold text-lg text-gray-800">${request.title}</h3>
                      <p class="text-sm text-gray-600 mb-2">${request.category}</p>
                      <p class="text-sm text-gray-700 mb-3">${request.description.substring(0, 100)}${request.description.length > 100 ? '...' : ''}</p>
                      <div class="flex justify-between items-center text-xs text-gray-500">
                          <span>Location: ${request.location || 'N/A'}</span>
                          <span>Budget: GHâ‚µ ${request.budget ? request.budget.toLocaleString() : 'N/A'}</span>
                      </div>
                      <div class="flex justify-between items-center text-xs text-gray-500 mt-1">
                          <span>Status: <span class="font-medium ${request.status === 'open' ? 'text-green-600' : 'text-red-600'}">${request.status}</span></span>
                          <span>Posted: ${new Date(request.created_at).toLocaleString()}</span>
                      </div>
                      
                      <!-- Post Status Toggle -->
                      <div class="flex items-center mt-4">
                          <label for="toggle-${request.id}" class="flex items-center cursor-pointer">
                              <div class="relative">
                                  <input type="checkbox" id="toggle-${request.id}" class="sr-only toggle-post-status" data-request-id="${request.id}" ${request.post_status ? 'checked' : ''}>
                                  <div class="block bg-gray-600 w-10 h-6 rounded-full"></div>
                                  <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                              </div>
                              <div class="ml-3 text-gray-700 font-medium">
                                  Post Status: <span class="status-text">${request.post_status ? 'On' : 'Off'}</span>
                              </div>
                          </label>
                      </div>
      
                      <button class="mt-4 bg-blue-600 hover:bg-blue-700 text-white rounded-md py-2 px-4 text-sm view-details-btn" data-request-id="${request.id}">View Details</button>
                      ${chatButtonHtml}
                  </article>
              `;
          });
      
          // Wait for all HTML strings to be generated before updating the DOM
          const requestHtmls = await Promise.all(requestHtmlPromises);
          myRequestsContainer.innerHTML = requestHtmls.join('');
      
      
          // Attach event listeners to the "View Details" buttons
          document.querySelectorAll('.view-details-btn').forEach(button => {
              button.addEventListener('click', (event) => {
                  const requestId = event.target.dataset.requestId;
                  const request = allUserRequests.get(requestId);
                  if (request) {
                      displayRequestDetailsModal(request);
                  }
              });
          });
      
          // Attach event listeners to the new "Chat with Agent" buttons
          document.querySelectorAll('.chat-with-agent-btn').forEach(button => {
              button.addEventListener('click', (event) => {
                  const requestId = event.target.dataset.requestId;
                  const userId = event.target.dataset.userId;
                  const agentId = event.target.dataset.agentId;
                  const agentName = event.target.dataset.agentName;
                  
                  if (requestId && userId && agentId) {
                      // Open the user_chat.html page in a new tab with relevant parameters
                      const chatUrl = `user_chat.html?request_id=${requestId}&user_id=${userId}&agent_id=${agentId}&agent_name=${encodeURIComponent(agentName)}`;
                      window.open(chatUrl, '_blank');
                  } else {
                      alert("Could not open chat. Missing request, user, or agent ID.");
                  }
              });
          });
      
          // Attach event listeners to the new "Post Status" toggles
          document.querySelectorAll('.toggle-post-status').forEach(toggle => {
              toggle.addEventListener('change', async (event) => {
                  const requestId = event.target.dataset.requestId;
                  const newStatus = event.target.checked;
                  const statusTextSpan = event.target.closest('label').querySelector('.status-text');
                  
                  if (statusTextSpan) {
                      statusTextSpan.textContent = newStatus ? 'On' : 'Off';
                  }
      
                  try {
                      await togglePostStatus(requestId, newStatus);
                      // Removed the alert for successful status update
                  } catch (error) {
                      console.error("Error toggling post status:", error);
                      alert("Failed to update post status. Please try again.");
                      // Revert the toggle state if update fails
                      event.target.checked = !newStatus;
                      if (statusTextSpan) {
                          statusTextSpan.textContent = !newStatus ? 'On' : 'Off';
                      }
                  }
              });
          });
      }

      function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]];
          }
          return array;
      }

      async function loadFeaturedAgents() {
          const { data, error } = await supabase
              .from('agents')
              .select('*')
              .order('is_featured', { ascending: false })
              .order('created_at', { ascending: false });

          const container = document.getElementById('featured-agents-container');
          const loading = document.getElementById('featured-loading');

          if (error || !data) {
              loading.textContent = "Failed to load featured agents.";
              return;
          }

          container.innerHTML = '';
          loading.style.display = 'none';

          const featuredAgents = data.filter(agent => agent.is_featured);

          if (featuredAgents.length === 0) {
              container.innerHTML = '<p class="text-center text-gray-500 col-span-full">No featured agents available at the moment.</p>';
              return;
          }

          for (const agent of featuredAgents) {
              let photoUrl = 'https://via.placeholder.com/300';
              if (agent.photo_path) {
                  const cleanedPath = agent.photo_path.startsWith('agent-images/')
                      ? agent.photo_path.replace('agent-images/', '')
                      : agent.photo_path;
                  photoUrl = `${storageBaseUrl}${cleanedPath}`;
              }

              container.innerHTML += `
                  <article class="bg-[#f7f9fc] rounded-xl overflow-hidden shadow-sm flex flex-col">
                      <img src="${photoUrl}" class="w-full object-cover object-top aspect-square" alt="${agent.full_name}" />
                      <div class="p-3">
                          <h3 class="font-semibold text-base">${agent.full_name}</h3>
                          <p class="text-sm text-green-500 flex items-center">
                              <span class="inline-flex items-center justify-center w-5 h-5 bg-green-500 text-white rounded-full mr-1">
                                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.09 3.36h3.53c.969 0 1.371 1.24.588 1.81l-2.857 2.073 1.09 3.36c.3.922-.755 1.688-1.54 1.118L10 12.347l-2.857 2.073c-.784.57-1.838-.196-1.539-1.118l1.09-3.36-2.857-2.073c-.784-.57-.38-1.81.588-1.81h3.53l1.09-3.36z"/>
                                  </svg>
                              </span>
                              ${agent.rating || '4.5'}
                          </p>
                          <p class="text-xs text-gray-800">${agent.category || 'Agent'}</p>
                          <button class="mt-2 bg-blue-900 hover:bg-green-600 text-white rounded-md py-1 px-4 text-sm w-full">
                              View Profile
                          </button>
                      </div>
                  </article>`;
          }
      }

      async function loadRandomAgents() {
          const { data, error } = await supabase
              .from('agents')
              .select('*')
              .eq('is_featured', false)
              .limit(20);

          const container = document.getElementById('random-agents-container');
          const loading = document.getElementById('random-loading');

          if (error || !data) {
              loading.textContent = "Failed to load other agents.";
              return;
          }

          container.innerHTML = '';
          loading.style.display = 'none';

          if (data.length === 0) {
              container.innerHTML = '<p class="text-center text-gray-500 col-span-full">No other agents available at the moment.</p>';
              return;
          }

          const shuffledAgents = shuffleArray(data).slice(0, 8);

          for (const agent of shuffledAgents) {
              let photoUrl = 'https://via.placeholder.com/300';
              if (agent.photo_path) {
                  const cleanedPath = agent.photo_path.startsWith('agent-images/')
                      ? agent.photo_path.replace('agent-images/', '')
                      : agent.photo_path;
                  photoUrl = `${storageBaseUrl}${cleanedPath}`;
              }

              container.innerHTML += `
                  <article class="bg-[#f7f9fc] rounded-xl overflow-hidden shadow-sm flex flex-col">
                      <img src="${photoUrl}" class="w-full object-cover object-top aspect-square" alt="${agent.full_name}" />
                      <div class="p-3">
                          <h3 class="font-semibold text-base">${agent.full_name}</h3>
                          <p class="text-sm text-yellow-500"><i class="fas fa-star"></i> ${agent.rating || '4.5'}</p>
                          <p class="text-xs text-gray-800">${agent.category || 'Agent'}</p>
                          <button class="mt-2 bg-blue-600 text-white rounded-md py-1 px-4 text-sm w-full">View Profile</button>
                      </div>
                  </article>`;
          }
      }

      async function loadAllOpenRequests() {
          const allRequestsContainer = document.getElementById('all-requests-container');
          const allRequestsLoading = document.getElementById('all-requests-loading');
          const allRequestsEmpty = document.getElementById('all-requests-empty');

          allRequestsContainer.innerHTML = '';
          allRequestsLoading.classList.remove('hidden');
          allRequestsEmpty.classList.add('hidden');
          allOpenRequestsMap.clear();
          openRequestsCountBadge.classList.add('hidden');

          const { data, error } = await supabase
              .from('user_requests')
              .select('*')
              .eq('status', 'open')
              .eq('post_status', true) // Only fetch requests where post_status is true
              .order('created_at', { ascending: false });

          allRequestsLoading.classList.add('hidden');

          if (error) {
              console.error("Error loading all open requests:", error.message);
              allRequestsContainer.innerHTML = `<p class="text-center text-red-500">Failed to load open requests.</p>`;
              return;
          }

          let requestsRenderedCount = 0;

          if (data.length > 0) {
              openRequestsCountBadge.textContent = data.length;
              openRequestsCountBadge.classList.remove('hidden');

              data.forEach(request => {
                  // Removed the condition that skips requests from the current user.
                  // Now, all open requests will be displayed.

                  allOpenRequestsMap.set(request.id, request);

                  allRequestsContainer.innerHTML += `
                      <article class="bg-[#f7f9fc] rounded-xl p-4 shadow-sm flex flex-col">
                          <h3 class="font-semibold text-lg text-gray-800">${request.title}</h3>
                          <p class="text-sm text-gray-600 mb-2">${request.category}</p>
                          <p class="text-sm text-gray-700 mb-3">${request.description.substring(0, 100)}${request.description.length > 100 ? '...' : ''}</p>
                          <div class="flex justify-between items-center text-xs text-gray-500">
                              <span>Location: ${request.location || 'N/A'}</span>
                              <span>Budget: GHâ‚µ ${request.budget ? request.budget.toLocaleString() : 'N/A'}</span>
                          </div>
                          <div class="flex justify-between items-center text-xs text-gray-500 mt-1">
                              <span>Posted: ${new Date(request.created_at).toLocaleString()}</span>
                          </div>
                          <button class="mt-4 bg-green-600 hover:bg-green-700 text-white rounded-md py-2 px-4 text-sm respond-to-request-btn" data-request-id="${request.id}">Respond to Request</button>
                      </article>
                  `;
                  requestsRenderedCount++;
              });
          }

          if (requestsRenderedCount === 0) {
              allRequestsEmpty.classList.remove('hidden');
          }

          // Attach event listeners to the "Respond to Request" buttons
          document.querySelectorAll('.respond-to-request-btn').forEach(button => {
              button.addEventListener('click', (event) => {
                  if (!currentUser) {
                      alert("Please log in as an agent to respond to requests.");
                      return;
                  }
                  const requestId = event.target.dataset.requestId;
                  const request = allOpenRequestsMap.get(requestId);
                  if (request) {
                      const chatUrl = `agents chat.html?request_id=${request.id}&user_id=${request.user_id}&agent_id=${currentUser.id}`;
                      window.open(chatUrl, '_blank'); // Open chat in a new tab
                  }
              });
          });
      }

      // Initialize the page
      checkUserAndDisplayAuth().then(() => {
          loadAllOpenRequests();
          loadFeaturedAgents();
          loadRandomAgents();
      });

      // New function to toggle post status in Supabase
      async function togglePostStatus(requestId, newStatus) {
          console.log(`Attempting to update post_status for request ID: ${requestId} to ${newStatus}`);
          const { data, error } = await supabase
              .from('user_requests')
              .update({ post_status: newStatus })
              .eq('id', requestId);

          if (error) {
              console.error("Supabase update error:", error); // Log the full error object from Supabase
              throw new Error(error.message);
          }
          console.log("Supabase update successful:", data); // Log the data returned on success
          return data;
      }
    });
  </script>
</body>
</html>